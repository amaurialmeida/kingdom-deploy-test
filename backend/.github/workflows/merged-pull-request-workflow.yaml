name: Merged Pull Request workflow
on:
  push:
    branches:
      - develop
  workflow_dispatch:
      
jobs:
  deploy:
    runs-on: ubuntu-latest
   
    steps:
      - name: Checkout repositorio
        uses: actions/checkout@v3
        
      - name: criar ./temp
        run: mkdir -p temp 

      - name: Criar .env
        run: touch .env ./temp 
        
      - name: Extract Branch Info
        id: branch_info
        run: |
          echo "pbi=9998" > ./temp/.env
          echo "branch_back_end=develop" >> ./temp/.env
          echo "subdominio=new-backend" >> ./temp/.env
         
      - name: copia .sh
        run: cp $GITHUB_WORKSPACE/.github/workflows/merged_Github_Auto_Deploy-New-Backend-erp.sh ./temp
        
      - name: listando pastas
        run: ls -a ./temp
        
      - name: cat .env
        run: cat ./temp/.env
        
      - name: cat .sh
        run: cat ./temp/merged_Github_Auto_Deploy-New-Backend-erp.sh               
        
      - name: ðŸ“‚ Sync files
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
           server: ftp.qacoders-academy.com.br
           username: ${{ secrets.FTP_USER }}
           password: ${{ secrets.FTP_PASSWORD }}
           protocol: ftps
           local-dir: ./temp/
           server-dir: /actionsdeploy-homolog/new-backend-erp/
           dangerous-clean-slate: true
          
          
      - name: SSH into remote server
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
          
      - name: Executando chown
        run: |
          ssh -T -o StrictHostKeyChecking=no root@191.252.210.196 'chown -R pipeline:www-data /var/www/html/actionsdeploy-homolog/new-backend-erp/'
      
      - name: Executando chmod +x
        run: |
          ssh -T -o StrictHostKeyChecking=no root@191.252.210.196 'chmod +x /var/www/html/actionsdeploy-homolog/new-backend-erp/merged_Github_Auto_Deploy-New-Backend-erp.sh'     
     
      - name: Executando script no server remoto
        run: |
          ssh -T -o StrictHostKeyChecking=no root@191.252.210.196 'cd /var/www/html/actionsdeploy-homolog/new-backend-erp && bash /var/www/html/actionsdeploy-homolog/new-backend-erp/merged_Github_Auto_Deploy-New-Backend-erp.sh'
